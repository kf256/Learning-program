<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta charset="utf-8">
        <title>
            Learning Program
        </title>
        <style>
            body {
                background-color: black;
            }
            #canvas {
                margin: 0px;
                position: absolute;
                top: 0px;
                left: 0px;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas">
        </canvas>
        <script src="./files/opentype.js">
        </script>
        <script src="./files/Chilanka-Regular.js">
        </script>
        <script src="./files/import.js">
        </script>
        <script src="./files/imageEarth.js">
        </script>
        <script src="./files/canvas.js">
        </script>
        <script src="./files/xyz.js">
        </script>
        <script src="./files/draw.js">
        </script>
        <script src="./files/numbers.js">
        </script>
        <script src="./files/touchfunctions.js">
        </script>
        <script>
            // simple and useful functions
            JSON.copy = function(e) {
                return JSON.parse(JSON.stringify(e));
            };
            let rand = function(number) {
                return Math.floor(Math.random()*number);
            };
            Number.prototype.clamp = function(min = 0, max = 1) {
                return Math.min(Math.max(this, min), max);
            };
            Array.prototype.shuffle = function() {
                for(let i = this.length-1; i > 0; i--) {
                    let j = rand(i+1);
                    [this[i], this[j]] = [this[j], this[i]];
                }
            };
            Array.prototype.random = function() {
                return this[rand(this.length)];
            };
            
            // most important variables
            let canvas = document.getElementById("canvas");
            let ctx = canvas.getContext("2d");
            let state = "not started";
            let tasks = [];
            
            // settings
            let maxfps = 30;
            let tasksSpeed = 1;
            let perspectiveFactor = 2;
            let taskNumber = 15;
            let taskDist = 20;
            let shownDigitsNum = 10;
            let cursorType = 0;
            let cursorSize = 0.01;
            let cursorSpeed = 0.001;
            
            // global variables of the draw functions
            let t = 0;
            let drawnumber = 0;
            let framerate = null;
            let framerateint = Math.round(framerate);
            let nextframerateintupdate = Date.now();
            let pos = {x: 0, y: 0, z: 0};
            let poslast = JSON.copy(pos);
            let speed = {x: 0, y: 0, z: 0};
            let speedlast = JSON.copy(speed);
            let rot = {x: 0, y: 0, z: 0};
            let direction = {x: 0, y: 0, z: 0};
            let time = Date.now();
            
            let enterFullscreen = function() {
                if      (document.body.requestFullscreen)       document.body.requestFullscreen();
                else if (document.body.webkitRequestFullscreen) document.body.webkitRequestFullscreen();
                else if (document.body.msRequestFullscreen)     document.body.msRequestFullscreen();
            };
            let exitFullscreen = function() {
                if      (document.exitFullscreen)       document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen)     document.msExitFullscreen();
            };
            let commands = function(text, x = 0, y = 0, size = 0.1, font = chilanka) {
                let cmd = font.getPath(text, 0, 0, size).commands;
                let minX = 0;
                let maxX = 0;
                let minY = 0;
                let maxY = 0;
                for (let i = 0; i < cmd.length; i++) {
                    switch (cmd[i].type) {
                        case "M": {
                            minX = Math.min(minX, cmd[i].x);
                            maxX = Math.max(maxX, cmd[i].x);
                            minY = Math.min(minY, cmd[i].y);
                            maxY = Math.max(maxY, cmd[i].y);
                            break;
                        }
                        case "L": {
                            minX = Math.min(minX, cmd[i].x);
                            maxX = Math.max(maxX, cmd[i].x);
                            minY = Math.min(minY, cmd[i].y);
                            maxY = Math.max(maxY, cmd[i].y);
                            break;
                        }
                        case "C": {
                            minX = Math.min(minX, cmd[i].x1);
                            maxX = Math.max(maxX, cmd[i].x1);
                            minY = Math.min(minY, cmd[i].y1);
                            maxY = Math.max(maxY, cmd[i].y1);
                            minX = Math.min(minX, cmd[i].x2);
                            maxX = Math.max(maxX, cmd[i].x2);
                            minY = Math.min(minY, cmd[i].y2);
                            maxY = Math.max(maxY, cmd[i].y2);
                            minX = Math.min(minX, cmd[i].x);
                            maxX = Math.max(maxX, cmd[i].x);
                            minY = Math.min(minY, cmd[i].y);
                            maxY = Math.max(maxY, cmd[i].y);
                            break;
                        }
                        case "Q": {
                            minX = Math.min(minX, cmd[i].x1);
                            maxX = Math.max(maxX, cmd[i].x1);
                            minY = Math.min(minY, cmd[i].y1);
                            maxY = Math.max(maxY, cmd[i].y1);
                            minX = Math.min(minX, cmd[i].x);
                            maxX = Math.max(maxX, cmd[i].x);
                            minY = Math.min(minY, cmd[i].y);
                            maxY = Math.max(maxY, cmd[i].y);
                            break;
                        }
                    }
                }
                let centerx = (minX+maxX)/2-x;
                let centery = (minY+maxY)/2-y;
                for (let i = 0; i < cmd.length; i++) {
                    switch (cmd[i].type) {
                        case "M": {
                            cmd[i].x -= centerx;
                            cmd[i].y -= centery;
                            break;
                        }
                        case "L": {
                            cmd[i].x -= centerx;
                            cmd[i].y -= centery;
                            break;
                        }
                        case "C": {
                            cmd[i].x1 -= centerx;
                            cmd[i].y1 -= centery;
                            cmd[i].x2 -= centerx;
                            cmd[i].y2 -= centery;
                            cmd[i].x -= centerx;
                            cmd[i].y -= centery;
                            break;
                        }
                        case "Q": {
                            cmd[i].x1 -= centerx;
                            cmd[i].y1 -= centery;
                            cmd[i].x -= centerx;
                            cmd[i].y -= centery;
                            break;
                        }
                    }
                }
                return cmd;
            };
            let randNumber = function() {
                let n = numbers;
                let k = Object.keys(n);
                let l = k.length;
                let p = 0;
                for (let i = 0; i < l; i++) p += n[k[i]].probability;
                for (let i = 0; i < l; i++) {
                    if (Math.random() < n[k[i]].probability/p) return n[k[i]];
                    else p -= n[k[i]].probability;
                }
            };
            let randNumberDigit = function(number) {
                let digits = number.digits.replace(".", "");
                let maxdigit = number.maxdigit;
                let digit = rand(maxdigit);
                return digit;
            };
            let shownNumberDigits = function(number, digit) {
                let digits = number.digits.replace(".", "");
                let pointpos = number.digits.indexOf(".");
                let startDigit = Math.max(digit-shownDigitsNum, 0);
                let shownDigits = digits.slice(startDigit, digit);
                let newPointpos = pointpos-startDigit;
                if (newPointpos > 0 && newPointpos <= shownDigits.length) {
                    let digitsBoforePoint = shownDigits.slice(0, newPointpos);
                    let digitsAfterPoint = shownDigits.slice(newPointpos, shownDigits.length);
                    shownDigits = digitsBoforePoint+"."+digitsAfterPoint;
                }
                shownDigits = String(shownDigits);
                if (startDigit != 0) shownDigits = "..."+shownDigits;
                shownDigits += "?...";
                return {shownDigits: shownDigits, solution: digits[digit]};
            };
            let newTasks = function() {
                tasks = new Array(taskNumber);
                for (let i = 0; i < taskNumber; i++) {
                    let number = randNumber();
                    let digit = randNumberDigit(number)
                    let shownDigits = shownNumberDigits(number, digit);
                    let solution = shownDigits.solution;
                    shownDigits = shownDigits.shownDigits;
                    let possibilities = [];
                    possibilities.push(solution);
                    for (let i = 0; i < 3; i++) {
                        let p = rand(10)+"";
                        while (possibilities.indexOf(p) != -1) p = rand(10)+"";
                        possibilities.push(p);
                    }
                    possibilities.shuffle();
                    let hint = "";
                    if (digit >= number.digits.indexOf(".")) hint = ordinalNumbers(digit-number.digits.indexOf(".")+1)+" decimal place";
                    let task = number.name+": "+shownDigits;
                    tasks[i] = {task: task, hint: hint, possibilities: possibilities, solution: solution};
                    continue;
                }
            };
            let numbertotext = function(number, decimalPlaces = 0, system = 10) {
                let text = Math.floor(number).toString(system);
                if (decimalPlaces == 0) return text;
                text+= ".";
                for (let i = 1; i <= decimalPlaces; i++) {
                    text+= (Math.floor(system**i*number)%system).toString(system);
                }
                return text;
            };
            let isPositiveInteger = function(number) {
                if (number%1 != 0) return false;
                if (number <= 0) return false;
                return true;
            };
            let ordinalNumbers = function(integer) {
                if (!isPositiveInteger(integer)) throw "The number isn't an integer!";
                let lastDigit = integer%10;
                if (lastDigit == 0 || lastDigit >= 4) return integer+"th";
                let penultimateDigit = (integer-lastDigit)/10%10;
                if (penultimateDigit == 1) return integer+"th";
                switch (lastDigit) {
                    case 1: return integer+"st";
                    case 2: return integer+"nd";
                    case 3: return integer+"rd";
                }
            };
            
            async function startEverything() {
                await loadFont();
                
                // draw start screen
                draw();
            }
            startEverything();
        </script>
    </body>
</html>